package co.edu.unicauca.commandrestaurant.presentation;

import co.edu.unicauca.commandrestaurant.Dominio.Crear_Command;
import co.edu.unicauca.commandrestaurant.Dominio.Borrar_Command;
import co.edu.unicauca.commandrestaurant.Dominio.Comida;
import co.edu.unicauca.commandrestaurant.Dominio.Decorator.CapitalFood;
import co.edu.unicauca.commandrestaurant.Infra.Mensajes;

import javax.swing.table.DefaultTableModel;
import co.edu.unicauca.commandrestaurant.Dominio.Invoker;
import co.edu.unicauca.commandrestaurant.Dominio.Encontrar_Todos_Los_Command;
import co.edu.unicauca.commandrestaurant.Dominio.Encontrar_Command_ID;
import co.edu.unicauca.commandrestaurant.Dominio.Tipo_ComidaEnum;
import co.edu.unicauca.commandrestaurant.Dominio.Actualizar_Command;
import co.edu.unicauca.commandrestaurant.Infra.Utilidades;

import java.util.List;
import javax.swing.DefaultComboBoxModel;

/**
 * Interfaz gráfica de Consultar clientes
 *
 * @author Libardo Pantoja, Daniel Paz
 *
 */
public class GUIFood extends javax.swing.JFrame {

    /**
	 * 
	 */
	private static final long serialVersionUID = 1L;
	/**
     * Instancia del invocador para poder enviar comandos al receptor
     * FoodService
     */
    private final Invoker invoker;

    /**
     * Constructor
     */
    public GUIFood() {
        invoker = new Invoker();
        initComponents();
        setSize(870, 300);
        loadDefaultValues();
        loadDataTable();
        loadDataCombo();
        initStateButtons();
        setLocationRelativeTo(null);

    }

    /**
     * Carga los tipos de comida en el jComboBox
     */
    private void loadDataCombo() {
        DefaultComboBoxModel model = new DefaultComboBoxModel();
        for (Tipo_ComidaEnum ft : Tipo_ComidaEnum.values()) {
            model.addElement(ft);
        }
        cboType.setModel(model);
    }
    
    private void loadDefaultValues(){
        addFood(1, "Fríjoles Negros", Tipo_ComidaEnum.PRINCIPIO);
        addFood(2, "Sopa de verduras sin Zanahoria", Tipo_ComidaEnum.ENTRADA);
        addFood(3, "Jugo de mango en leche", Tipo_ComidaEnum.JUGO);
    }

    /**
     * Poner los botones en su estado inicial
     */
    private void initStateButtons() {
        btnAdd.setEnabled(false);
        btnUpdate.setEnabled(false);
        btnDelete.setEnabled(false);
        btnUndo.setEnabled(invoker.hasCommandUndo());
    }

    /**
     * Carga las comidas en el jTable
     */
    private void loadDataTable() {
        invoker.setCommand(new Encontrar_Todos_Los_Command());
        invoker.execute();
        Encontrar_Todos_Los_Command findAllCommand = (Encontrar_Todos_Los_Command) invoker.getCommand();
        List<Comida> components = findAllCommand.getFoods();
        DefaultTableModel modelTable = (DefaultTableModel) tblData.getModel();
        clearData(modelTable);
        for (Comida component : components) {
            Object[] fila = new Object[3];
            fila[0] = component.getId();
            fila[1] = component.getNombre();
            fila[2] = component.getTipo().toString();
            modelTable.addRow(fila);
        }
    }

    /**
     * Elimina las filas del jTable
     *
     * @param modelTable modelo de datos del jTable
     */
    private void clearData(DefaultTableModel modelTable) {
        while (modelTable.getRowCount() > 0) {
            modelTable.removeRow(0);
        }
    }

    /**
     * Mensaje inicial del panel superior
     */
    /**
     * This method is called from within the constructor to initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is always
     * regenerated by the Form Editor.
     */
    @SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        pnlCentro = new javax.swing.JPanel();
        lblId = new javax.swing.JLabel();
        txtId = new javax.swing.JTextField();
        lblName = new javax.swing.JLabel();
        txtName = new javax.swing.JTextField();
        lblType = new javax.swing.JLabel();
        cboType = new javax.swing.JComboBox<>();
        pnlSur = new javax.swing.JPanel();
        btnAdd = new javax.swing.JButton();
        btnUpdate = new javax.swing.JButton();
        btnDelete = new javax.swing.JButton();
        btnUndo = new javax.swing.JButton();
        btnClose = new javax.swing.JButton();
        pnlEste = new javax.swing.JPanel();
        jScrollPane1 = new javax.swing.JScrollPane();
        tblData = new javax.swing.JTable();

        setTitle("Comidas del Menú Diario");

        pnlCentro.setBorder(javax.swing.BorderFactory.createLineBorder(new java.awt.Color(0, 0, 0)));
        pnlCentro.setLayout(new java.awt.GridLayout(3, 2));

        lblId.setHorizontalAlignment(javax.swing.SwingConstants.RIGHT);
        lblId.setText("*Id:");
        pnlCentro.add(lblId);

        txtId.setPreferredSize(new java.awt.Dimension(150, 32));
        txtId.addFocusListener(new java.awt.event.FocusAdapter() {
            public void focusLost(java.awt.event.FocusEvent evt) {
                txtIdFocusLost(evt);
            }
        });
        txtId.addKeyListener(new java.awt.event.KeyAdapter() {
            public void keyPressed(java.awt.event.KeyEvent evt) {
                txtIdKeyPressed(evt);
            }
        });
        pnlCentro.add(txtId);

        lblName.setHorizontalAlignment(javax.swing.SwingConstants.RIGHT);
        lblName.setText("*Nombre:");
        pnlCentro.add(lblName);
        pnlCentro.add(txtName);

        lblType.setHorizontalAlignment(javax.swing.SwingConstants.RIGHT);
        lblType.setText("*Tipo:");
        pnlCentro.add(lblType);

        cboType.setModel(new javax.swing.DefaultComboBoxModel<>(new String[] { "INPUT", "JUICE", "PRINCIPIO" }));
        pnlCentro.add(cboType);

        getContentPane().add(pnlCentro, java.awt.BorderLayout.CENTER);

        pnlSur.setBorder(javax.swing.BorderFactory.createLineBorder(new java.awt.Color(0, 0, 0)));

        btnAdd.setText("Agregar");
        btnAdd.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btnAddActionPerformed(evt);
            }
        });
        pnlSur.add(btnAdd);

        btnUpdate.setText("Modificar");
        btnUpdate.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btnUpdateActionPerformed(evt);
            }
        });
        pnlSur.add(btnUpdate);

        btnDelete.setText("Eliminar");
        btnDelete.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btnDeleteActionPerformed(evt);
            }
        });
        pnlSur.add(btnDelete);

        btnUndo.setText("Deshacer");
        btnUndo.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btnUndoActionPerformed(evt);
            }
        });
        pnlSur.add(btnUndo);

        btnClose.setText("Cerrar");
        btnClose.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btnCloseActionPerformed(evt);
            }
        });
        pnlSur.add(btnClose);

        getContentPane().add(pnlSur, java.awt.BorderLayout.SOUTH);

        pnlEste.setBorder(new javax.swing.border.MatteBorder(null));
        pnlEste.setLayout(new java.awt.BorderLayout());

        tblData.setModel(new javax.swing.table.DefaultTableModel(
            new Object [][] {

            },
            new String [] {
                "Id", "Nombre", "Tipo"
            }
        ) {
            boolean[] canEdit = new boolean [] {
                false, false, false
            };

            public boolean isCellEditable(int rowIndex, int columnIndex) {
                return canEdit [columnIndex];
            }
        });
        jScrollPane1.setViewportView(tblData);

        pnlEste.add(jScrollPane1, java.awt.BorderLayout.CENTER);

        getContentPane().add(pnlEste, java.awt.BorderLayout.EAST);

        pack();
    }// </editor-fold>//GEN-END:initComponents

    private void btnCloseActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btnCloseActionPerformed
        this.dispose();
    }//GEN-LAST:event_btnCloseActionPerformed
    public String getTxtyId() {
        return txtId.getText();
    }

    private void btnAddActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btnAddActionPerformed
        String name = txtName.getText();
        if (name.isEmpty()) {
            Mensajes.warningMessage("Debe agregar un nombre", "Atención");
            txtName.requestFocus();
            return;
        }

        int id = Integer.parseInt(txtId.getText());
        String type = cboType.getSelectedItem().toString();
        Tipo_ComidaEnum foodTpye = Tipo_ComidaEnum.valueOf(type);

        addFood(id, name, foodTpye);

        Mensajes.successMessage("Comida agregada con éxito", "Atención");
        clearControls();
        initStateButtons();
        loadDataTable();

    }//GEN-LAST:event_btnAddActionPerformed

    /**
     * Llama a la logica de negocio para agregar comida mediante el comando
     *
     * @param id identificador de la comida
     * @param name nombre de la comida
     * @param type tipo de comida
     */
    private void addFood(int id, String name, Tipo_ComidaEnum type) {
        Comida food = new CapitalFood(id, name, type);

        //Fija el comando del invoker
        invoker.setCommand(new Crear_Command(food));
        //Ejecuta el comando
        invoker.execute();
    }


    private void btnUpdateActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btnUpdateActionPerformed
        String name = txtName.getText();
        if (name.isEmpty()) {
            Mensajes.warningMessage("Debe agregar un nombre", "Atención");
            txtName.requestFocus();
            return;
        }
        // Preparar los datos
        int id = Integer.parseInt(txtId.getText());
        String type = cboType.getSelectedItem().toString();
        Tipo_ComidaEnum foodTpye = Tipo_ComidaEnum.valueOf(type);

        // Crea la comida con los nuevos datos
        Comida food = new CapitalFood(id, name, foodTpye);

        // Traer la comida previa        
        invoker.setCommand(new Encontrar_Command_ID());
        Encontrar_Command_ID findByIdCommand = (Encontrar_Command_ID) invoker.getCommand();
        findByIdCommand.setFoodId(id);
        invoker.execute();

        //La comida previa debe crearse en una nueva instancia
        Comida compAux = findByIdCommand.getFood();
        Comida previous = new Comida(compAux.getId(), compAux.getNombre(), compAux.getTipo());

        //Modifica la comida y guarda el previo
        updateFood(food, previous);

        Mensajes.successMessage("Comida modificada con éxito", "Atención");
        clearControls();
        initStateButtons();
        loadDataTable();
    }//GEN-LAST:event_btnUpdateActionPerformed
    /**
     * Llama a la logica de negocio para modificar comida mediante el comando
     *
     * @param food comida a editar
     * @param previous comida antes de ser modificada
     */
    private void updateFood(Comida food, Comida previous) {
        //Fija el Actualizar_Command
        invoker.setCommand(new Actualizar_Command(food));
        Actualizar_Command updateCommand = (Actualizar_Command) invoker.getCommand();
        //Fija al comida previa
        updateCommand.setFoodPrevious(previous);
        //Ejecuta el comando
        invoker.execute();
    }

    private void txtIdFocusLost(java.awt.event.FocusEvent evt) {//GEN-FIRST:event_txtIdFocusLost
        String strId = txtId.getText().trim();
        if (strId.isEmpty()) {
            return;
        }

        //Fija el comando del invoker para buscar comida por id
        invoker.setCommand(new Encontrar_Command_ID());
        //Pasa parámetros al comando
        Encontrar_Command_ID findByIdCommand = (Encontrar_Command_ID) invoker.getCommand();
        findByIdCommand.setFoodId(Integer.parseInt(strId));
        //Ejecuta el comando
        invoker.execute();
        Comida food = findByIdCommand.getFood();

        if (food == null) {
            //Agregar
            btnAdd.setEnabled(true);
            btnUndo.setEnabled(false);
            btnUpdate.setEnabled(false);
            btnDelete.setEnabled(false);

        } else {
            //Editar
            btnUpdate.setEnabled(true);
            btnDelete.setEnabled(true);
            btnUndo.setEnabled(false);
            txtName.setText(Utilidades.desencriptar(food.getNombre()));
            cboType.setSelectedItem(food.getTipo().toString());
        }

    }//GEN-LAST:event_txtIdFocusLost

    private void btnUndoActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btnUndoActionPerformed
        //Ejecuta el comando deshacer
        invoker.undo();
        loadDataTable();
        initStateButtons();
    }//GEN-LAST:event_btnUndoActionPerformed

    private void txtIdKeyPressed(java.awt.event.KeyEvent evt) {//GEN-FIRST:event_txtIdKeyPressed
        if (evt.getKeyCode() == java.awt.event.KeyEvent.VK_ENTER) {
            txtIdFocusLost(null);
            txtName.requestFocus();
        }
    }//GEN-LAST:event_txtIdKeyPressed

    private void btnDeleteActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btnDeleteActionPerformed
        String strId = txtId.getText().trim();

        // Traer la comida previa        
        int id = Integer.parseInt(strId);
        invoker.setCommand(new Encontrar_Command_ID());
        Encontrar_Command_ID findByIdCommand = (Encontrar_Command_ID) invoker.getCommand();
        findByIdCommand.setFoodId(id);
        invoker.execute();
        Comida compAux = findByIdCommand.getFood();
        Comida foodSaved = new Comida(compAux.getId(), compAux.getNombre(), compAux.getTipo());

        //Elimina la comida
        deleteFood(foodSaved);

        Mensajes.successMessage("Comida eliminada con éxito", "Atención");
        clearControls();
        initStateButtons();
        loadDataTable();
    }//GEN-LAST:event_btnDeleteActionPerformed
    /**
     * Llama a la logica de negocio para comida comida mediante el comando
     *
     * @param food comida a eliminar
     *
     */
    private void deleteFood(Comida food) {
        //Fija el comando del invoker
        invoker.setCommand(new Borrar_Command(food));
        //Ejecuta el comando
        invoker.execute();
    }

    /**
     * Limpia las cajas de texto
     */
    public void clearControls() {
        txtId.setText("");
        txtName.setText("");
        cboType.setSelectedIndex(0);
    }

    public static void main(String[] args) {
        GUIFood gui = new GUIFood();
        gui.setVisible(true);
    }


    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JButton btnAdd;
    private javax.swing.JButton btnClose;
    private javax.swing.JButton btnDelete;
    private javax.swing.JButton btnUndo;
    private javax.swing.JButton btnUpdate;
    private javax.swing.JComboBox<String> cboType;
    private javax.swing.JScrollPane jScrollPane1;
    private javax.swing.JLabel lblId;
    private javax.swing.JLabel lblName;
    private javax.swing.JLabel lblType;
    private javax.swing.JPanel pnlCentro;
    private javax.swing.JPanel pnlEste;
    private javax.swing.JPanel pnlSur;
    private javax.swing.JTable tblData;
    private javax.swing.JTextField txtId;
    private javax.swing.JTextField txtName;
    // End of variables declaration//GEN-END:variables
}
